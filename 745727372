--[[
    YirdeX墨水游戏脚本 - 完整功能版
    整合了所有墨水游戏功能
]]

-- 防止重复加载
if getgenv().YirdeX_InkGame_Loaded then
    return
end
getgenv().YirdeX_InkGame_Loaded = true

-- 创建必要的文件夹
local function setupFolders()
    local folders = {
        "YirdeX_Scripts",
        "YirdeX_Scripts/Themes",
        "YirdeX_Scripts/Configs",
        "YirdeX_Scripts/Profiles"
    }
    
    for _, folder in ipairs(folders) do
        if not isfolder(folder) then
            makefolder(folder)
        end
    end
end

pcall(setupFolders)

-- 加载库
local repo = "https://raw.githubusercontent.com/XcRNB/Obsidian-CNHK/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()
local ThemeManager = loadstring(game:HttpGet(repo .. "addons/ThemeManager.lua"))()
local SaveManager = loadstring(game:HttpGet(repo .. "addons/SaveManager.lua"))()

local Options = Library.Options
local Toggles = Library.Toggles

-- 创建主窗口
local Window = Library:CreateWindow({
    Title = "YirdeX-墨水游戏脚本",
    Footer = "完整版 v2.1 | YirdeX出品",
    Center = true,
    AutoShow = true,
    Resizable = true,
    ShowCustomCursor = true,
    TabPadding = 2,
    MenuFadeTime = 0.1
})

-- 创建选项卡
local Tabs = {
    Main = Window:AddTab("主要功能", "gamepad-2"),
    Visual = Window:AddTab("视觉功能", "eye"),
    Player = Window:AddTab("玩家增强", "user"),
    Auto = Window:AddTab("自动游戏", "zap"),
    Misc = Window:AddTab("杂项功能", "wrench"),
    UISettings = Window:AddTab("UI设置", "settings")
}

-- 游戏服务
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Lighting = game:GetService("Lighting")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- 全局变量
local Script = {
    Maid = {},
    Connections = {},
    ESPTable = {},
    Temp = {},
    GameState = "未知",
    ESPInstances = {}
}

-- 清理函数
function Script.Cleanup()
    for _, connection in pairs(Script.Connections) do
        pcall(function() connection:Disconnect() end)
    end
    for _, object in pairs(Script.Maid) do
        pcall(function() object:Destroy() end)
    end
    for _, esp in pairs(Script.ESPInstances) do
        pcall(function() esp:Destroy() end)
    end
    table.clear(Script.Connections)
    table.clear(Script.Maid)
    table.clear(Script.ESPTable)
    table.clear(Script.Temp)
    table.clear(Script.ESPInstances)
end

-- 通知函数
function Script.Notify(message, duration)
    Library:Notify(message, duration or 3)
end

-- ================================
-- ESP绘制系统
-- ================================
function Script.CreateESP(object, color, name, offset)
    if not object or not object:IsDescendantOf(Workspace) then return end
    
    local esp = {}
    esp.Object = object
    esp.Color = color
    
    -- 创建高亮
    local highlight = Instance.new("Highlight")
    highlight.Adornee = object
    highlight.FillColor = color
    highlight.OutlineColor = color
    highlight.FillTransparency = Options.ESP_FillTransparency.Value
    highlight.OutlineTransparency = Options.ESP_OutlineTransparency.Value
    highlight.Enabled = Toggles.ESP_Highlight.Value
    highlight.Parent = object
    
    -- 创建文字标签
    local billboard = Instance.new("BillboardGui")
    billboard.Adornee = object
    billboard.Size = UDim2.new(0, 100, 0, 50)
    billboard.StudsOffset = offset or Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = name
    label.TextColor3 = color
    label.TextSize = Options.ESP_TextSize.Value
    label.Font = Enum.Font.GothamBold
    label.Parent = billboard
    
    billboard.Parent = object
    
    esp.Highlight = highlight
    esp.Billboard = billboard
    
    -- 更新函数
    function esp.Update()
        if not object or not object:IsDescendantOf(Workspace) then
            esp.Destroy()
            return
        end
        
        highlight.Enabled = Toggles.ESP_Highlight.Value
        highlight.FillTransparency = Options.ESP_FillTransparency.Value
        highlight.OutlineTransparency = Options.ESP_OutlineTransparency.Value
        highlight.FillColor = color
        highlight.OutlineColor = color
        
        label.TextSize = Options.ESP_TextSize.Value
        label.TextColor3 = color
        
        if Toggles.ESP_ShowDistance.Value and LocalPlayer.Character then
            local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if root then
                local distance = math.floor((root.Position - object.Position).Magnitude)
                label.Text = string.format("%s\n[%d]", name, distance)
            end
        else
            label.Text = name
        end
    end
    
    function esp.Destroy()
        if highlight then highlight:Destroy() end
        if billboard then billboard:Destroy() end
        if Script.ESPInstances[esp] then
            Script.ESPInstances[esp] = nil
        end
    end
    
    Script.ESPInstances[esp] = esp
    return esp
end

-- 创建ESP管理循环
function Script.StartESPLoop()
    if Script.Connections.ESPLoop then return end
    
    Script.Connections.ESPLoop = RunService.RenderStepped:Connect(function()
        for _, esp in pairs(Script.ESPInstances) do
            esp.Update()
        end
    end)
end

-- 添加玩家ESP
function Script.AddPlayerESP(player)
    if player == LocalPlayer then return end
    
    local character = player.Character
    if not character then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local root = character:FindFirstChild("HumanoidRootPart")
    if not humanoid or not root then return end
    
    local color = Options.ESP_PlayerColor.Value
    local esp = Script.CreateESP(character, color, player.Name, Vector3.new(0, 3, 0))
    
    -- 监听玩家变化
    local healthConnection = humanoid.HealthChanged:Connect(function(health)
        if esp and esp.Billboard and esp.Billboard:FindFirstChild("TextLabel") then
            esp.Billboard.TextLabel.Text = string.format("%s\nHP: %d", player.Name, math.floor(health))
        end
    end)
    
    Script.Maid[player] = healthConnection
end

-- 更新所有ESP
function Script.UpdateAllESP()
    for _, esp in pairs(Script.ESPInstances) do
        esp.Update()
    end
end

-- ================================
-- 玩家ESP功能
-- ================================
Toggles.ESP_Player:OnChanged(function(value)
    if value then
        -- 为所有玩家添加ESP
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                if player.Character then
                    Script.AddPlayerESP(player)
                end
                -- 监听新角色
                Script.Connections[player] = player.CharacterAdded:Connect(function()
                    task.wait(1)
                    Script.AddPlayerESP(player)
                end)
            end
        end
        
        -- 监听新玩家
        Script.Connections.PlayerAdded = Players.PlayerAdded:Connect(function(player)
            task.wait(2)
            Script.AddPlayerESP(player)
        end)
        
        Script.StartESPLoop()
        Script.Notify("玩家ESP已启用", 3)
    else
        -- 清理ESP
        for _, esp in pairs(Script.ESPInstances) do
            esp.Destroy()
        end
        table.clear(Script.ESPInstances)
        
        -- 清理连接
        for name, conn in pairs(Script.Connections) do
            if name ~= "ESPLoop" then
                pcall(function() conn:Disconnect() end)
                Script.Connections[name] = nil
            end
        end
        
        Script.Notify("玩家ESP已禁用", 3)
    end
end)

-- ================================
-- 主要功能选项卡
-- ================================
local MainGroup = Tabs.Main:AddLeftGroupbox("游戏功能")

-- 红绿灯上帝模式
local RLGL_GodModeActive = false
local RLGL_OriginalNamecall
Toggles.RLGL_GodMode:OnChanged(function(value)
    if value then
        -- 检查是否在红绿灯游戏中
        if not Workspace:FindFirstChild("RedLightGreenLight") then
            Script.Notify("红绿灯游戏未开始", 3)
            Toggles.RLGL_GodMode:SetValue(false)
            return
        end
        
        Script.Notify("红绿灯上帝模式已启用", 3)
        RLGL_GodModeActive = true
        
        -- 保存当前位置
        if LocalPlayer.Character then
            Script.Temp.RLGL_SavedPosition = LocalPlayer.Character:GetPivot()
        end
        
        -- 监听位置变化
        Script.Connections.RLGL_Heartbeat = RunService.Heartbeat:Connect(function()
            if not RLGL_GodModeActive then return end
            if LocalPlayer.Character then
                Script.Temp.RLGL_SavedPosition = LocalPlayer.Character:GetPivot()
            end
        end)
        
        -- Hook网络调用防止死亡
        if hookmetamethod then
            RLGL_OriginalNamecall = hookmetamethod(game, "__namecall", function(self, ...)
                local args = {...}
                local method = getnamecallmethod()
                
                if tostring(self) == "rootCFrame" and method == "FireServer" then
                    if RLGL_GodModeActive and Script.Temp.RLGL_SavedPosition then
                        args[1] = Script.Temp.RLGL_SavedPosition
                    end
                end
                
                return RLGL_OriginalNamecall(self, unpack(args))
            end)
        end
    else
        RLGL_GodModeActive = false
        if Script.Connections.RLGL_Heartbeat then
            Script.Connections.RLGL_Heartbeat:Disconnect()
        end
        
        if RLGL_OriginalNamecall then
            hookmetamethod(game, "__namecall", RLGL_OriginalNamecall)
        end
        
        Script.Notify("红绿灯上帝模式已禁用", 3)
    end
end)

-- 瞬间通关红绿灯
MainGroup:AddButton("RLGL_InstantWin", {
    Text = "瞬间通关",
    Func = function()
        if not Workspace:FindFirstChild("RedLightGreenLight") then
            Script.Notify("红绿灯游戏未开始", 3)
            return
        end
        
        local character = LocalPlayer.Character
        if character then
            -- 先禁用上帝模式以免冲突
            if Toggles.RLGL_GodMode.Value then
                Toggles.RLGL_GodMode:SetValue(false)
                wait(0.1)
            end
            
            -- 传送到终点
            local success = pcall(function()
                character:PivotTo(CFrame.new(Vector3.new(-100.8, 1030, 115)))
            end)
            
            if success then
                Script.Notify("已传送到红绿灯终点", 3)
            else
                Script.Notify("传送失败", 3)
            end
        else
            Script.Notify("角色不存在", 3)
        end
    end,
    Tooltip = "瞬间传送到终点"
})

-- 扣糖饼功能
Toggles.Dalgona_Immune:OnChanged(function(value)
    if value then
        Script.Notify("糖饼免疫已启用", 3)
        -- 这里可以添加免疫代码
    else
        Script.Notify("糖饼免疫已禁用", 3)
    end
end)

MainGroup:AddButton("Dalgona_InstantWin", {
    Text = "瞬间完成糖饼",
    Func = function()
        local remote = ReplicatedStorage:FindFirstChild("Remotes"):FindFirstChild("DALGONATEMPREMPTE")
        if not remote then
            Script.Notify("糖饼游戏未开始", 3)
            return
        end
        
        -- 发送完成信号
        remote:FireServer({Success = true})
        remote:FireServer({Completed = true})
        
        -- 执行绕过
        local character = LocalPlayer.Character
        if character then
            -- 透明化角色
            for _, part in ipairs(character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.Transparency = 1
                end
            end
            
            -- 修复相机
            if Camera then
                Camera.CameraType = Enum.CameraType.Custom
                Camera.CameraSubject = character:FindFirstChild("Humanoid")
            end
        end
        
        Script.Notify("糖饼游戏已完成", 3)
    end
})

-- 拔河功能
Toggles.TugOfWar_Auto:OnChanged(function(value)
    if value then
        Script.Notify("自动拔河已启用", 3)
        Script.Connections.TugOfWar = RunService.Heartbeat:Connect(function()
            if not Toggles.TugOfWar_Auto.Value then return end
            
            local remote = ReplicatedStorage:FindFirstChild("Remotes"):FindFirstChild("TemporaryReachedBindable")
            if remote then
                local args = {
                    {PerfectQTE = Toggles.TugOfWar_Perfect.Value}
                }
                remote:FireServer(unpack(args))
            end
        end)
    else
        if Script.Connections.TugOfWar then
            Script.Connections.TugOfWar:Disconnect()
        end
        Script.Notify("自动拔河已禁用", 3)
    end
})

-- 玻璃桥功能
MainGroup:AddButton("GlassBridge_ShowSafe", {
    Text = "显示安全玻璃",
    Func = function()
        if not Workspace:FindFirstChild("GlassBridge") then
            Script.Notify("玻璃桥游戏未开始", 3)
            return
        end
        
        -- 显示安全玻璃
        local glassHolder = Workspace.GlassBridge:FindFirstChild("GlassHolder")
        if glassHolder then
            for _, tilePair in pairs(glassHolder:GetChildren()) do
                for _, tileModel in pairs(tilePair:GetChildren()) do
                    if tileModel:IsA("Model") and tileModel.PrimaryPart then
                        local isBreakable = tileModel.PrimaryPart:GetAttribute("exploitingisevil") == true
                        local color = isBreakable and Color3.fromRGB(255, 0, 0) or Color3.fromRGB(0, 255, 0)
                        
                        -- 创建高亮
                        local highlight = Instance.new("Highlight")
                        highlight.Adornee = tileModel
                        highlight.FillColor = color
                        highlight.FillTransparency = 0.5
                        highlight.OutlineColor = color
                        highlight.OutlineTransparency = 0
                        highlight.Parent = tileModel
                        
                        Script.Maid[tileModel] = highlight
                    end
                end
            end
        end
        
        Script.Notify("已显示玻璃桥安全/危险区域", 5)
    end
})

MainGroup:AddButton("GlassBridge_InstantWin", {
    Text = "瞬间通关",
    Func = function()
        local character = LocalPlayer.Character
        if character then
            local success = pcall(function()
                character:PivotTo(CFrame.new(Vector3.new(-203.9, 520.7, -1534.3485)))
            end)
            
            if success then
                Script.Notify("已传送到玻璃桥终点", 3)
            else
                Script.Notify("传送失败", 3)
            end
        end
    end
})

-- 捉迷藏功能
Toggles.HideSeek_InfiniteStamina:OnChanged(function(value)
    if value then
        Script.Notify("无限体力已启用", 3)
        Script.Connections.InfiniteStamina = RunService.Heartbeat:Connect(function()
            local character = LocalPlayer.Character
            if character then
                local stamina = character:FindFirstChild("StaminaVal")
                if stamina then
                    stamina.Value = 100
                end
            end
        end)
    else
        if Script.Connections.InfiniteStamina then
            Script.Connections.InfiniteStamina:Disconnect()
        end
        Script.Notify("无限体力已禁用", 3)
    end
end)

MainGroup:AddButton("HideSeek_TPToHider", {
    Text = "传送到躲藏者",
    Func = function()
        local hider
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player:GetAttribute("IsHider") then
                hider = player
                break
            end
        end
        
        if hider and hider.Character then
            local success = pcall(function()
                LocalPlayer.Character:PivotTo(hider.Character:GetPrimaryPartCFrame())
            end)
            
            if success then
                Script.Notify("已传送到躲藏者", 3)
            else
                Script.Notify("传送失败", 3)
            end
        else
            Script.Notify("未找到躲藏者", 3)
        end
    end
})

-- ================================
-- 玩家增强功能
-- ================================

-- 速度修改
local OriginalWalkSpeed = 16
Toggles.Speed_Toggle:OnChanged(function(value)
    local character = LocalPlayer.Character
    if character and character:FindFirstChild("Humanoid") then
        if value then
            OriginalWalkSpeed = character.Humanoid.WalkSpeed
            character.Humanoid.WalkSpeed = Options.Speed_Value.Value
            Script.Connections.SpeedUpdate = Options.Speed_Value:OnChanged(function(val)
                if Toggles.Speed_Toggle.Value then
                    character.Humanoid.WalkSpeed = val
                end
            end)
            Script.Notify("速度修改已启用: " .. Options.Speed_Value.Value, 3)
        else
            character.Humanoid.WalkSpeed = OriginalWalkSpeed
            if Script.Connections.SpeedUpdate then
                Script.Connections.SpeedUpdate:Disconnect()
            end
            Script.Notify("速度修改已禁用", 3)
        end
    end
end)

-- 穿墙模式
Toggles.Noclip_Toggle:OnChanged(function(value)
    if value then
        Script.Notify("穿墙模式已启用", 3)
        Script.Connections.Noclip = RunService.Stepped:Connect(function()
            local character = LocalPlayer.Character
            if character then
                for _, part in ipairs(character:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
            end
        end)
    else
        if Script.Connections.Noclip then
            Script.Connections.Noclip:Disconnect()
        end
        Script.Notify("穿墙模式已禁用", 3)
    end
end)

-- 无限跳跃
Toggles.InfiniteJump_Toggle:OnChanged(function(value)
    if value then
        Script.Notify("无限跳跃已启用", 3)
        Script.Connections.InfiniteJump = UserInputService.JumpRequest:Connect(function()
            local character = LocalPlayer.Character
            if character and character:FindFirstChild("Humanoid") then
                character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end)
    else
        if Script.Connections.InfiniteJump then
            Script.Connections.InfiniteJump:Disconnect()
        end
        Script.Notify("无限跳跃已禁用", 3)
    end
end)

-- 飞行模式
local FlyBodyVelocity
Toggles.Fly_Toggle:OnChanged(function(value)
    if value then
        Script.Notify("飞行模式已启用", 3)
        
        local character = LocalPlayer.Character
        if not character then return end
        
        local humanoid = character:FindFirstChild("Humanoid")
        local root = character:FindFirstChild("HumanoidRootPart")
        
        if not humanoid or not root then return end
        
        -- 启用平台站立
        humanoid.PlatformStand = true
        
        -- 创建BodyVelocity
        FlyBodyVelocity = Instance.new("BodyVelocity")
        FlyBodyVelocity.Velocity = Vector3.new(0, 0, 0)
        FlyBodyVelocity.MaxForce = Vector3.new(40000, 40000, 40000)
        FlyBodyVelocity.P = 1250
        FlyBodyVelocity.Parent = root
        
        -- 飞行控制
        Script.Connections.FlyControl = RunService.RenderStepped:Connect(function()
            if not Toggles.Fly_Toggle.Value or not FlyBodyVelocity then return end
            
            local moveDirection = Vector3.new(0, 0, 0)
            local speed = Options.Fly_Speed.Value
            
            -- 获取输入方向
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                moveDirection = moveDirection + Camera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                moveDirection = moveDirection - Camera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                moveDirection = moveDirection - Camera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                moveDirection = moveDirection + Camera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                moveDirection = moveDirection + Vector3.new(0, 1, 0)
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
                moveDirection = moveDirection - Vector3.new(0, 1, 0)
            end
            
            -- 更新速度
            if moveDirection.Magnitude > 0 then
                moveDirection = moveDirection.Unit * speed
                FlyBodyVelocity.Velocity = moveDirection
            else
                FlyBodyVelocity.Velocity = Vector3.new(0, 0, 0)
            end
        end)
    else
        -- 禁用飞行
        if FlyBodyVelocity then
            FlyBodyVelocity:Destroy()
            FlyBodyVelocity = nil
        end
        
        if Script.Connections.FlyControl then
            Script.Connections.FlyControl:Disconnect()
        end
        
        local character = LocalPlayer.Character
        if character and character:FindFirstChild("Humanoid") then
            character.Humanoid.PlatformStand = false
        end
        
        Script.Notify("飞行模式已禁用", 3)
    end
end)

-- 杀戮光环
Toggles.Killaura_Toggle:OnChanged(function(value)
    if value then
        Script.Notify("杀戮光环已启用", 3)
        
        Script.Connections.Killaura = RunService.Heartbeat:Connect(function()
            if not Toggles.Killaura_Toggle.Value then return end
            
            local character = LocalPlayer.Character
            if not character then return end
            
            local root = character:FindFirstChild("HumanoidRootPart")
            if not root then return end
            
            -- 寻找最近的目标
            local nearestTarget = nil
            local nearestDistance = 15 -- 攻击范围
            
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character then
                    local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
                    local humanoid = player.Character:FindFirstChild("Humanoid")
                    
                    if targetRoot and humanoid and humanoid.Health > 0 then
                        local distance = (root.Position - targetRoot.Position).Magnitude
                        if distance < nearestDistance then
                            nearestTarget = targetRoot
                            nearestDistance = distance
                        end
                    end
                end
            end
            
            -- 攻击目标
            if nearestTarget then
                -- 面向目标（如果开启静默瞄准）
                if Toggles.SilentAim_Toggle.Value then
                    local direction = (nearestTarget.Position - root.Position).Unit
                    root.CFrame = CFrame.new(root.Position, root.Position + direction)
                end
                
                -- 寻找武器并攻击
                local tool = Script.GetWeapon()
                if tool then
                    Script.AttackWithWeapon(tool, nearestTarget.Position)
                end
            end
        end)
    else
        if Script.Connections.Killaura then
            Script.Connections.Killaura:Disconnect()
        end
        Script.Notify("杀戮光环已禁用", 3)
    end
end)

-- 辅助函数：获取武器
function Script.GetWeapon()
    local character = LocalPlayer.Character
    if not character then return nil end
    
    -- 检查角色手中的武器
    for _, tool in ipairs(character:GetChildren()) do
        if tool:IsA("Tool") then
            return tool
        end
    end
    
    -- 检查背包
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if backpack then
        for _, tool in ipairs(backpack:GetChildren()) do
            if tool:IsA("Tool") then
                return tool
            end
        end
    end
    
    return nil
end

-- 辅助函数：使用武器攻击
function Script.AttackWithWeapon(tool, targetPosition)
    -- 确保武器在手中
    if tool.Parent ~= LocalPlayer.Character then
        local humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid:EquipTool(tool)
        end
    end
    
    -- 发送攻击请求
    local remote = ReplicatedStorage:FindFirstChild("Remotes"):FindFirstChild("UsedTool")
    if remote then
        local args = {
            "UsingMoveCustom",
            tool,
            true,
            {Clicked = true}
        }
        remote:FireServer(unpack(args))
    end
end

-- 静默瞄准
Toggles.SilentAim_Toggle:OnChanged(function(value)
    if value then
        Script.Notify("静默瞄准已启用", 3)
        
        Script.Connections.SilentAim = RunService.RenderStepped:Connect(function()
            if not Toggles.SilentAim_Toggle.Value then return end
            
            local character = LocalPlayer.Character
            if not character then return end
            
            local root = character:FindFirstChild("HumanoidRootPart")
            if not root then return end
            
            -- 寻找最近的玩家
            local nearestTarget = nil
            local nearestDistance = math.huge
            
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character then
                    local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
                    local humanoid = player.Character:FindFirstChild("Humanoid")
                    
                    if targetRoot and humanoid and humanoid.Health > 0 then
                        local distance = (root.Position - targetRoot.Position).Magnitude
                        if distance < nearestDistance and distance < 100 then
                            if Toggles.Aimbot_Wallcheck.Value then
                                -- 墙壁检测
                                local raycastResult = workspace:Raycast(
                                    root.Position,
                                    (targetRoot.Position - root.Position).Unit * distance,
                                    {character}
                                )
                                if not raycastResult then
                                    nearestTarget = targetRoot
                                    nearestDistance = distance
                                end
                            else
                                nearestTarget = targetRoot
                                nearestDistance = distance
                            end
                        end
                    end
                end
            end
            
            -- 瞄准目标
            if nearestTarget then
                local direction = (nearestTarget.Position - root.Position).Unit
                local aimSpeed = Options.Aimbot_Speed.Value
                
                -- 平滑瞄准
                local currentLook = root.CFrame.LookVector
                local targetLook = direction
                local smoothedLook = currentLook:Lerp(targetLook, aimSpeed)
                
                root.CFrame = CFrame.new(root.Position, root.Position + smoothedLook)
            end
        end)
    else
        if Script.Connections.SilentAim then
            Script.Connections.SilentAim:Disconnect()
        end
        Script.Notify("静默瞄准已禁用", 3)
    end
end)

-- ================================
-- 杂项功能
-- ================================

-- 全亮模式
Toggles.Fullbright_Toggle:OnChanged(function(value)
    if value then
        Script.Notify("全亮模式已启用", 3)
        
        -- 保存原始设置
        Script.Temp.OriginalBrightness = Lighting.Brightness
        Script.Temp.OriginalTime = Lighting.ClockTime
        Script.Temp.OriginalFogEnd = Lighting.FogEnd
        
        -- 设置全亮
        Lighting.Brightness = 2
        Lighting.ClockTime = 14
        Lighting.FogEnd = 100000
        Lighting.FogStart = 100000
        Lighting.GlobalShadows = false
        
        -- 监听设置变化
        Script.Connections.Fullbright = Lighting.Changed:Connect(function()
            if Toggles.Fullbright_Toggle.Value then
                Lighting.Brightness = 2
                Lighting.ClockTime = 14
                Lighting.FogEnd = 100000
                Lighting.FogStart = 100000
                Lighting.GlobalShadows = false
            end
        end)
    else
        -- 恢复原始设置
        if Script.Temp.OriginalBrightness then
            Lighting.Brightness = Script.Temp.OriginalBrightness
        end
        if Script.Temp.OriginalTime then
            Lighting.ClockTime = Script.Temp.OriginalTime
        end
        if Script.Temp.OriginalFogEnd then
            Lighting.FogEnd = Script.Temp.OriginalFogEnd
        end
        
        if Script.Connections.Fullbright then
            Script.Connections.Fullbright:Disconnect()
        end
        
        Script.Notify("全亮模式已禁用", 3)
    end
end)

-- 低画质模式
Toggles.LowGFX_Toggle:OnChanged(function(value)
    if value then
        Script.Notify("低画质模式已启用", 3)
        
        -- 保存原始设置
        Script.Temp.OriginalQuality = settings().Rendering.QualityLevel
        
        -- 降低画质
        settings().Rendering.QualityLevel = 1
        
        -- 降低材质质量
        for _, part in ipairs(Workspace:GetDescendants()) do
            if part:IsA("Part") or part:IsA("MeshPart") then
                part.Material = Enum.Material.Plastic
                part.Reflectance = 0
            end
        end
    else
        -- 恢复画质
        if Script.Temp.OriginalQuality then
            settings().Rendering.QualityLevel = Script.Temp.OriginalQuality
        end
        
        Script.Notify("低画质模式已禁用", 3)
    end
end)

-- 反虚空
Toggles.AntiVoid_Toggle:OnChanged(function(value)
    if value then
        Script.Notify("反虚空已启用", 3)
        
        -- 创建虚空检测平台
        local antiVoidPart = Instance.new("Part")
        antiVoidPart.Size = Vector3.new(10000, 5, 10000)
        antiVoidPart.Position = Vector3.new(0, 0, 0)
        antiVoidPart.Transparency = 0.5
        antiVoidPart.Color = Color3.fromRGB(0, 255, 0)
        antiVoidPart.Anchored = true
        antiVoidPart.CanCollide = true
        antiVoidPart.Name = "AntiVoidPlatform"
        antiVoidPart.Parent = Workspace
        
        Script.Maid.AntiVoidPart = antiVoidPart
        
        -- 位置更新
        Script.Connections.AntiVoid = RunService.Heartbeat:Connect(function()
            local character = LocalPlayer.Character
            if character then
                local root = character:FindFirstChild("HumanoidRootPart")
                if root and root.Position.Y < 0 then
                    root.CFrame = CFrame.new(0, 50, 0)
                end
            end
        end)
    else
        -- 清理
        if Script.Maid.AntiVoidPart then
            Script.Maid.AntiVoidPart:Destroy()
        end
        if Script.Connections.AntiVoid then
            Script.Connections.AntiVoid:Disconnect()
        end
        
        Script.Notify("反虚空已禁用", 3)
    end
end)

-- 反布娃娃
Toggles.AntiRagdoll_Toggle:OnChanged(function(value)
    if value then
        Script.Notify("反布娃娃已启用", 3)
        
        Script.Connections.AntiRagdoll = RunService.Heartbeat:Connect(function()
            local character = LocalPlayer.Character
            if character then
                -- 移除布娃娃文件夹
                for _, folderName in pairs({"Ragdoll", "Stun", "InjuredWalking"}) do
                    local folder = character:FindFirstChild(folderName)
                    if folder then
                        folder:Destroy()
                    end
                end
                
                -- 防止布娃娃状态
                local humanoid = character:FindFirstChild("Humanoid")
                if humanoid then
                    humanoid.PlatformStand = false
                end
            end
        end)
    else
        if Script.Connections.AntiRagdoll then
            Script.Connections.AntiRagdoll:Disconnect()
        end
        Script.Notify("反布娃娃已禁用", 3)
    end
end)

-- 反击退
Toggles.AntiFling_Toggle:OnChanged(function(value)
    if value then
        Script.Notify("反击退已启用", 3)
        
        Script.Connections.AntiFling = RunService.Heartbeat:Connect(function()
            local character = LocalPlayer.Character
            if character then
                -- 移除速度部件
                for _, part in ipairs(character:GetDescendants()) do
                    if part:IsA("BodyVelocity") or part:IsA("BodyAngularVelocity") then
                        part:Destroy()
                    end
                end
                
                -- 限制速度
                local root = character:FindFirstChild("HumanoidRootPart")
                if root then
                    local velocity = root.Velocity
                    if velocity.Magnitude > 100 then
                        root.Velocity = velocity.Unit * 100
                    end
                end
            end
        end)
    else
        if Script.Connections.AntiFling then
            Script.Connections.AntiFling:Disconnect()
        end
        Script.Notify("反击退已禁用", 3)
    end
end)

-- 反AFK
Toggles.AntiAFK_Toggle:OnChanged(function(value)
    if value then
        Script.Notify("反AFK已启用", 3)
        Script.Connections.AntiAFK = LocalPlayer.Idled:Connect(function()
            VirtualUser:Button2Down(Vector2.new(0, 0), Camera.CFrame)
            wait(1)
            VirtualUser:Button2Up(Vector2.new(0, 0), Camera.CFrame)
        end)
    else
        if Script.Connections.AntiAFK then
            Script.Connections.AntiAFK:Disconnect()
        end
        Script.Notify("反AFK已禁用", 3)
    end
end)

-- 移除布娃娃效果按钮
local MiscGroup = Tabs.Misc:AddLeftGroupbox("实用功能")
MiscGroup:AddButton("RemoveRagdoll", {
    Text = "移除布娃娃效果",
    Func = function()
        local character = LocalPlayer.Character
        if not character then return end
        
        for _, folderName in pairs({"Ragdoll", "Stun", "InjuredWalking"}) do
            local folder = character:FindFirstChild(folderName)
            if folder then
                folder:Destroy()
            end
        end
        
        -- 修复骨骼
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.PlatformStand = false
            humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
        end
        
        Script.Notify("已移除布娃娃效果", 3)
    end
})

-- 传送功能
MiscGroup:AddDivider()
MiscGroup:AddLabel("传送功能"):AddDivider()

MiscGroup:AddButton("Teleport_Safe", {
    Text = "传送到安全点",
    Func = function()
        local character = LocalPlayer.Character
        if character then
            character:PivotTo(CFrame.new(Vector3.new(-108, 329.1, 462.1)))
            Script.Notify("已传送到安全点", 3)
        end
    end
})

MiscGroup:AddButton("Teleport_Back", {
    Text = "传回到原位置",
    Func = function()
        if Script.Temp.LastPosition then
            LocalPlayer.Character:PivotTo(Script.Temp.LastPosition)
            Script.Notify("已传回原位置", 3)
        else
            Script.Notify("没有保存的位置", 3)
        end
    end
})

MiscGroup:AddButton("Teleport_Hide", {
    Text = "传送到隐藏点",
    Func = function()
        LocalPlayer.Character:PivotTo(CFrame.new(Vector3.new(229.9, 1005.3, 169.4)))
        Script.Notify("已传送到隐藏点", 3)
    end
})

MiscGroup:AddButton("Fix_Camera", {
    Text = "修复相机",
    Func = function()
        if Camera then
            Camera.CameraType = Enum.CameraType.Custom
            if LocalPlayer.Character then
                Camera.CameraSubject = LocalPlayer.Character:FindFirstChild("Humanoid")
            end
            Script.Notify("相机已修复", 3)
        end
    end
})

-- ================================
-- UI设置
-- ================================
local MenuGroup = Tabs.UISettings:AddLeftGroupbox("菜单设置")

MenuGroup:AddToggle("KeybindMenu_Toggle", {
    Text = "显示按键绑定",
    Default = false,
    Callback = function(value)
        Library.KeybindFrame.Visible = value
    end
})

MenuGroup:AddToggle("CustomCursor_Toggle", {
    Text = "自定义光标",
    Default = true,
    Callback = function(value)
        Library.ShowCustomCursor = value
    end
})

MenuGroup:AddDropdown("Notification_Side", {
    Text = "通知位置",
    Values = {"左侧", "右侧"},
    Default = "右侧",
    Callback = function(value)
        Library:SetNotifySide(value == "左侧" and "Left" or "Right")
    end
})

MenuGroup:AddDivider()

MenuGroup:AddLabel("菜单快捷键"):AddKeyPicker("MenuKeybind", {
    Default = "RightShift",
    NoUI = true,
    Text = "菜单快捷键"
})

MenuGroup:AddButton("Unload_Script", {
    Text = "卸载脚本",
    Func = function()
        Library:Unload()
    end
})

MenuGroup:AddButton("Save_Settings", {
    Text = "保存设置",
    Func = function()
        SaveManager:Save()
        Script.Notify("设置已保存", 3)
    end
})

-- ================================
-- 初始化
-- ================================

-- 设置菜单快捷键
Library.ToggleKeybind = Options.MenuKeybind

-- 配置主题管理器
ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)

SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({"MenuKeybind"})

ThemeManager:SetFolder("YirdeX_Scripts")
SaveManager:SetFolder("YirdeX_Scripts/Configs")

-- 构建配置菜单
SaveManager:BuildConfigSection(Tabs.UISettings)

-- 应用主题
ThemeManager:ApplyToTab(Tabs.UISettings)

-- 加载自动加载的配置
SaveManager:LoadAutoloadConfig()

-- 加载完成提示
task.spawn(function()
    wait(1)
    Script.Notify("YirdeX墨水游戏脚本加载完成！", 5)
end)

-- 卸载清理
Library:OnUnload(function()
    Script.Cleanup()
    getgenv().YirdeX_InkGame_Loaded = false
    Script.Notify("脚本已卸载", 3)
end)
